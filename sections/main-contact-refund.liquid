<style>
  .form .sm-salomon__inquiryDetails {
    resize: none;
  }

  .overlay .inner .line-1,
  .overlay-type .line-2 p {
    color: var(--color-white);
  }

  .form input,
  .form .sm-salomon__inquiryDetails {
    border-radius: 4px;
  }

  #page-content .central.sm-salomon__contactWrapper {
    width: 100%;
    padding: 64px 20px 144px;
  }

  #page-content .central.sm-salomon__contactWrapper .form {
    max-width: 1065px;
    padding: 0;
  }

  #page-content .central.sm-salomon__contactWrapper .form .input-row {
    display: flex;
    gap: 24px;
    margin: 0;
    padding: 16px 0;
    border-bottom: 1px solid var(--color-grey-14);
  }

  .sm-salomon__label {
    flex-basis: 11%;
    display: flex;
    align-items: center;
  }

  .sm-salomon__input {
    flex-basis: 85%;
    margin: 0;
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
  }

  .sm-salomon__contactLabel {
    font-family: var(--font-primary);
    font-size: var(--font-size-14);
    font-style: normal;
    font-weight: var(--font-weight-500);
    line-height: normal;
    color: var(--color-grey-13);
    text-align: var(--text-left);
    text-transform: var(--text-capitalize);
  }

  .sm-salomon__contactFirstName,
  .sm-salomon__contactLastName,
  .sm-salomon__contactPhone,
  .sm-salomon__contactEmail,
  .sm-salomon__contactTitle,
  .sm-salomon__totalProducts,
  .sm-salomon__refundProducts {
    width: 100%;
    max-width: 380px;
    margin: 0;
  }

  .sm-salomon__contactTitle {
    background: var(--color-aliceblue);
    border-color: var(--color-grey-08);
  }

  .sm-salomon__contactWrapper .form .wide-action .sm-salomon__contactButton {
    max-width: 163px;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 48px;
    margin: 0 auto;
    font-family: var(--font-primary);
    font-size: var(--font-size-14);
    font-style: normal;
    font-weight: var(--font-weight-500);
    line-height: 1;
    color: var(--color-white);
  }

  #page-content .central.sm-salomon__contactWrapper .form .input-row.sm-salomon__inquiryWrap {
    border: none;
    padding-bottom: 0;
    align-items: flex-start;
  }

  .sm-salomon__contactWrapper .feature-header:not(.feature-header__no-gap) {
    font-family: var(--font-primary);
    font-size: var(--font-size-27);
    font-weight: var(--font-weight-700);
    line-height: normal;
    text-transform: var(--text-uppercase);
    color: var(--color-black);
  }

  .sm-salomon__contactWrapper .feature-header:not(.feature-header__no-gap):after {
    content: none;
  }

  .sm-salomon__textWrapper {
    display: flex;
    gap: 16px;
    justify-content: center;
    align-items: center;
    padding-bottom: 40px;
    width: 100%;
    max-width: 1065px;
    margin: 0 auto;
    border-bottom: 2px solid var(--color-black);
  }

  .sm-salomon__text strong {
    font-weight: var(--font-weight-500);
  }

  .form input,
  .form .sm-salomon__inquiryDetails {
    padding: 16px;
    outline-color: var(--color-black);
  }

  .form input {
    height: 50px;
  }

  .form .sm-salomon__inquiryDetails {
    height: 380px;
  }

  .form input::placeholder,
  .form .sm-salomon__inquiryDetails::placeholder {
    font-family: var(--font-primary);
    font-size: var(--font-size-14);
    font-weight: var(--font-weight-400);
    line-height: normal;
    color: var(--color-grey-04);
  }

  .sm-salomon__text * {
    font-family: var(--font-primary);
    font-size: var(--font-size-14);
    font-style: normal;
    font-weight: var(--font-weight-400);
    color: var(--color-grey-01);
  }

  .sm-salomon__successMessage {
    padding-top: 50px;
    font-weight: var(--font-weight-700);
  }

  .sm-salomon__listOfProducts {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .sm-salomon__imageLeftCol {
    background: var(--color-grey-16);
    width: 35px;
    max-width: 35px;
    aspect-ratio: 1/1;
    height: 35px;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .sm-salomon__listOfProducts .sm-salomon__contentRightCol {
    flex-basis: 88%;
  }

  .sm-salomon__orderDetailsTitle {
    text-align: var(--text-left);
    color: var(--color-black);
    font-family: var(--font-primary);
    font-size: var(--font-size-14);
    font-style: normal;
    font-weight: var(--font-weight-400);
    line-height: normal;
  }

  .sm-salomon__orderDetailsVariant {
    text-align: var(--text-left);
    font-family: var(--font-primary);
    font-size: var(--font-size-12);
    font-style: normal;
    font-weight: var(--font-weight-400);
    line-height: normal;
    color: var(--color-grey-02);
  }

  .sm-salomon__input.sm-salomon__input--listOfProducts {
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .sm-salomon__input.sm-salomon__input--listOfProducts input[type='checkbox'] {
    width: 14px;
    height: 14px;
    padding: 0;
    border: 1px solid var(--color-grey-14);
    border-radius: 3px;
  }

  .sm-salomon__listOfCheckbox {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-basis: auto;
    border: 1px solid var(--color-grey-10);
    border-radius: 4px;
    background: var(--color-white);
    padding: 10px 20px;
  }

  .sm-salomon__listOfCheckbox label {
    width: 100%;
  }

  .sm-salomon__listOfCheckbox.sm-salomon__listOfCheckbox--checked {
    border-color: var(--color-grey-13);
  }

  .sm-salomon__input.sm-salomon__input--listOfProducts input[type='checkbox'] {
    position: relative;
  }

  .sm-salomon__input.sm-salomon__input--listOfProducts .sm-salomon__listOfCheckbox input[type='checkbox']:before,
  .sm-salomon__input.sm-salomon__input--listOfProducts
    .sm-salomon__listOfCheckbox--checked
    input[type='checkbox']:before {
    content: '';
    position: absolute;
    z-index: 9;
    width: 18px;
    height: 18px;
    top: -2px;
    right: -3px;
    bottom: 0;
  }

  .sm-salomon__input.sm-salomon__input--listOfProducts .sm-salomon__listOfCheckbox input[type='checkbox']:before {
    background: url({{'Frame_1000005015_1.svg'|file_url}}) no-repeat;
    background-size: contain;
  }

  .sm-salomon__input.sm-salomon__input--listOfProducts
    .sm-salomon__listOfCheckbox--checked
    input[type='checkbox']:before {
    background: url({{'Frame_1000005015.svg'|file_url}}) no-repeat;
    background-size: contain;
    display: none;
  }

  .sm-salomon__input.sm-salomon__input--listOfProducts
    .sm-salomon__listOfCheckbox.sm-salomon__listOfCheckbox--checked
    input[type='checkbox'] {
    border: none;
  }

  .sm-salomon__input.sm-salomon__input--listOfProducts
    .sm-salomon__listOfCheckbox.sm-salomon__listOfCheckbox--checked
    input[type='checkbox']:before {
    display: block;
  }

  .form .sm-salomon__inquiryDetails {
    height: 110px;
  }

  .form input,
  .form .sm-salomon__inquiryDetails {
    color: var(--color-grey-13);
    font-family: var(--font-primary);
    font-size: var(--font-size-14);
    font-style: normal;
    font-weight: var(--font-weight-400);
    line-height: normal;
  }

  .form input::placeholder,
  .form .sm-salomon__inquiryDetails::placeholder {
    color: var(--color-grey-04);
  }

  .form .sm-salomon__contactTitle {
    color: var(--color-grey-02);
  }

  @media (max-width: 768px) {
    .as-contact_content {
      padding-bottom: 20px;
    }

    .sm-salomon__listOfCheckbox {
      flex-basis: 100%;
    }

    .sm-salomon__textWrapper,
    #page-content .central.sm-salomon__contactWrapper .form .input-row {
      flex-wrap: wrap;
      gap: 8px;
    }

    #page-content .central.sm-salomon__contactWrapper {
      padding: 40px 20px 80px;
    }

    .form .sm-salomon__inquiryDetails {
      height: 335px;
    }

    .sm-salomon__label,
    .sm-salomon__input {
      flex-basis: 100%;
    }

    .sm-salomon__contactWrapper .form .wide-action .sm-salomon__contactButton,
    .sm-salomon__contactFirstName,
    .sm-salomon__contactLastName,
    .sm-salomon__contactPhone,
    .sm-salomon__contactEmail,
    .sm-salomon__contactTitle,
    .sm-salomon__totalProducts,
    .sm-salomon__refundProducts {
      max-width: 100%;
    }

    #page-content .central.sm-salomon__contactWrapper .form .input-row {
      padding: 20px 0;
    }

    .sm-salomon__contactWrapper .feature-header:not(.feature-header__no-gap) {
      margin-bottom: 8px;
    }
  }
</style>

<div class="central py-medium sm-salomon__contactWrapper" data-cc-animate data-cc-animate-delay="0.2s">
  {% if section.settings.show_title %}
    <h1 class="feature-header">{{ page.title }}</h1>
  {% endif %}

  <div class="sm-salomon__textWrapper">
    {% for block in section.blocks %}
      <div class="sm-salomon__text">
        {{ block.settings.text }}
      </div>
    {% endfor %}
  </div>

  {%- assign page_url = content_for_header
    | split: '"pageurl":"'
    | last
    | split: '"'
    | first
    | split: request.host
    | last
    | replace: '\/', '/'
    | replace: '%20', ' '
    | replace: '\u0026', '&'
  -%}

  {% liquid
    assign order_id = ''
    assign refund_line_item_id = ''

    if page_url contains '?'
      assign query_string = page_url | split: '?' | last
      assign qry_parts = query_string | split: '&'

      for part in qry_parts
        assign key_and_value = part | split: '='
        if key_and_value.size > 1
          if key_and_value[0] == 'order_id'
            assign order_id = key_and_value[1]
          elsif key_and_value[0] == 'refund_line_item_id'
            assign refund_line_item_id = key_and_value[1]
          endif
        endif
      endfor
    endif

    assign order_id = order_id | plus: 0
  %}

  {% form 'contact' %}
    {% if form.posted_successfully? %}
      <div class="rte align-center sm-salomon__successMessage">
        {{ 'contact.form.post_success' | t }}
      </div>

    {% else %}
      {% if form.errors %}
        <div class="errors">
          <p>{{ 'contact.form.post_error' | t }}</p>
          {% assign message_label = 'contact.form.message' | t %}
          <ul>
            {% for field in form.errors %}
              <li>{{ field | replace: 'body', message_label | capitalize }} - {{ form.errors.messages[field] }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
      <div class="form">
        <div class="input-row">
          <div class="sm-salomon__label">
            <label class="sm-salomon__contactLabel">이름*</label>
          </div>
          <div class="sm-salomon__input">
            <input
              aria-label="이름"
              placeholder="이름"
              type="text"
              class="required sm-salomon__contactLastName"
              id="contact_name"
              {% if customer %}
                value="{{ customer.name }}"
              {% endif %}
              required
              name="contact[name]"
            >
          </div>
        </div>
        <div class="input-row">
          <div class="sm-salomon__label">
            <label class="sm-salomon__contactLabel">휴대폰번호*</label>
          </div>
          <div class="sm-salomon__input">
            <input
              aria-label="phone"
              placeholder="휴대폰번호"
              type="tel"
              id="contact_phone"
              data-phoneNumber
              maxlength="20"
              required
              {% if customer %}
                value="{{ customer.phone }}"
              {% endif %}
              class="email required sm-salomon__contactPhone"
              name="contact[phone]"
            >
          </div>
        </div>
        <div class="input-row">
          <div class="sm-salomon__label">
            <label class="sm-salomon__contactLabel">E-mail*</label>
          </div>
          <div class="sm-salomon__input">
            <input
              aria-label="이메일"
              placeholder="이메일 주소"
              type="email"
              id="contact_email"
              required
              {% if customer %}
                value="{{ customer.email }}"
              {% endif %}
              class="email required sm-salomon__contactEmail"
              name="contact[email]"
            >
          </div>
        </div>
        <div class="input-row input-row--productCode">
          <div class="sm-salomon__label">
            <label class="sm-salomon__contactLabel">제목*</label>
          </div>
          <div class="sm-salomon__input">
            <input
              aria-label="Title"
              placeholder="문의하실 내용의 제목을 적어주세요."
              type="text"
              id="contact_title"
              class="required email sm-salomon__contactTitle"
              name="contact[Order Code]"
              {% if customer %}
                value="{% for order in customer.orders %}{% assign current_order_id = order.id | plus: 0 %}{% if current_order_id == order_id %}{{ order.name }} 주문 반품신청{% endif %}{% endfor %}"
                readonly
              {% endif %}
            >
          </div>
        </div>

        {% liquid
          assign total_items_count = 0
          assign refund_items_count = 0

          if customer
            for order in customer.orders
              assign current_order_id = order.id | plus: 0

              if current_order_id == order_id
                assign total_items_count = order.line_items.size
                for line_item in order.line_items
                  if refund_line_item_id contains line_item.id
                    assign refund_items_count = refund_items_count | plus: 1
                  endif
                endfor
              endif
            endfor
          endif
        %}

        {% if customer %}
          <div class="input-row input-row--productCode input-row--productOrder">
            <div class="sm-salomon__label">
              <label class="sm-salomon__contactLabel">반품상품*</label>
            </div>
            <div class="sm-salomon__input sm-salomon__input--listOfProducts">
              {% for order in customer.orders %}
                {% assign current_order_id = order.id | plus: 0 %}
                {% if current_order_id == order_id %}
                  {% for line_item in order.line_items %}
                    <div class="sm-salomon__listOfCheckbox{% if refund_line_item_id contains line_item.id %} sm-salomon__listOfCheckbox--checked{% endif %}"
                      data-list-of-checkboxes
                    >
                      <input
                        type="checkbox"
                        name="contact[{{ line_item.product.title }}]"
                        id="{{ line_item.variant.id }}"
                        name="{{ line_item.product.id }}"
                        value="{{ line_item.title }}"
                        data-line-item-id="{{ line_item.id }}"
                        data-checkbox="true"
                        {% if refund_line_item_id contains line_item.id %}
                          checked
                        {% endif %}
                      >
                      <label for="{{ line_item.product.id }}">
                        <div class="sm-salomon__listOfProducts" for="{{ line_item.product.id }}">
                          <div class="sm-salomon__imageLeftCol">
                            {% if line_item.product.featured_image %}
                              <img
                                src="{{ line_item.product.featured_image.src | img_url: 'medium' }}"
                                alt="{{ line_item.title }}"
                                width="auto"
                                height="auto"
                                loading="lazy"
                              >
                            {% endif %}
                          </div>
                          <div class="sm-salomon__contentRightCol">
                            <h2 class="sm-salomon__orderDetailsTitle">
                              {{ line_item.product.title }}
                            </h2>
                            <h5 class="sm-salomon__orderDetailsVariant">
                              {{ line_item.variant.title }}
                            </h5>
                          </div>
                        </div>
                      </label>
                    </div>
                  {% endfor %}
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <div class="input-row input-row--productCount">
          <div class="sm-salomon__label">
            <label class="sm-salomon__contactLabel">Total*</label>
          </div>
          <div class="sm-salomon__input">
            <input
              aria-label="Total Products/Variants"
              type="text"
              id="total_items_count"
              class="required sm-salomon__totalProducts"
              name="contact[Total Items Count]"
              value="{{ total_items_count }}"
              readonly
            >
          </div>
        </div>
        <div class="input-row input-row--refundCount">
          <div class="sm-salomon__label">
            <label class="sm-salomon__contactLabel">Refunding*</label>
          </div>
          <div class="sm-salomon__input">
            <input
              aria-label="Refunding"
              type="text"
              id="refund_items_count"
              class="required sm-salomon__refundProducts"
              name="contact[Refund Items Count]"
              value="{{ refund_items_count }}"
              data-refund-items-count
              readonly
            >
          </div>
        </div>

        <div class="input-row sm-salomon__inquiryWrap">
          <div class="sm-salomon__label">
            <label class="sm-salomon__contactLabel">반품사유*</label>
          </div>
          <div class="sm-salomon__input">
            <textarea
              aria-label="메시지"
              placeholder="반품 사유를 적어주세요."
              id="message"
              class="required sm-salomon__inquiryDetails"
              required
              name="contact[Inquirydetails]"
            ></textarea>
          </div>
        </div>
        <div class="wide-action">
          <input type="submit" class="sm-salomon__contactButton" value="반품 신청하기">
        </div>
      </div>
    {% endif %}
  {% endform %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const phoneNumberInputs = document.querySelectorAll('[data-phoneNumber], [data-orderNumber]');
    phoneNumberInputs.forEach(function (input) {
      input.addEventListener('keypress', function (e) {
        const charCode = e.which ? e.which : e.keyCode;
        if (String.fromCharCode(charCode).match(/[^0-9]/g)) {
          e.preventDefault();
        }
      });
    });

    var alertShown = false;
    document.getElementById('contact_form').addEventListener('submit', function (event) {
      var inputs = document.querySelectorAll('[data-required]');
      var isValid = true;

      inputs.forEach(function (input) {
        if (input.value.trim() === '') {
          isValid = false;
        }
      });

      if (!isValid) {
        if (!alertShown) {
          alertShown = true;
          alert('* 표시된 항목은 필수 기재 항목입니다.');
          event.preventDefault();
        } else {
          alert('* 표시된 항목은 필수 기재 항목입니다.');
          event.preventDefault();
        }
      } else {
        alertShown = false;
      }
    });

    var refund_line_item_id = '{{ refund_line_item_id }}';
    var checkboxes = document.querySelectorAll('[data-list-of-checkboxes] [data-checkbox]');
    var refundItemsInput = document.querySelector('[data-refund-items-count]');

    // Ensure refundItemsInput.value is a valid number
    var initialRefundCount = parseInt(refundItemsInput.value, 10) || 0;

    // Function to update refund count based on checkbox state
    function updateRefundCount() {
      var checkedCount = 0;
      checkboxes.forEach(function (checkbox) {
        if (checkbox.checked) {
          checkedCount++;
        }
      });
      refundItemsInput.value = checkedCount;
    }

    // Update the refund count on initial load
    updateRefundCount();

    // Add event listeners to update count and style when checkboxes change
    checkboxes.forEach(function (checkbox) {
      var lineItemID = checkbox.getAttribute('data-line-item-id');

      // Automatically check the checkbox with the matching refund_line_item_id
      if (lineItemID === refund_line_item_id) {
        checkbox.checked = true;
      }

      // Add or remove class based on checkbox state
      var parentDiv = checkbox.closest('.sm-salomon__listOfCheckbox');
      if (checkbox.checked) {
        parentDiv.classList.add('sm-salomon__listOfCheckbox--checked');
      } else {
        parentDiv.classList.remove('sm-salomon__listOfCheckbox--checked');
      }

      // Update refund count on change
      checkbox.addEventListener('change', function () {
        if (this.checked) {
          parentDiv.classList.add('sm-salomon__listOfCheckbox--checked');
        } else {
          parentDiv.classList.remove('sm-salomon__listOfCheckbox--checked');
        }
        updateRefundCount();
      });
    });
  });
</script>

{% schema %}
{
  "name": "Contact form Refund",
  "max_blocks": 5,
  "settings": [
    {
      "type": "checkbox",
      "id": "show_title",
      "label": "Show page title",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "text",
      "name": "Text",
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "Label"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Contact Form Refund"
    }
  ]
}
{% endschema %}
